<template>
  <div>
    <a-card style="width: 100%"
            :body-style="{padding: 0}">
      <h3 slot="title">Web Vulnerabilities</h3>
      <div slot="extra" style="width: 500px">
        <a-input-search style="width: 370px; margin-right: 30px"
                        v-model="searchWord"
                        @change="onSearchChange"
                        @search="onSearchChange"
                        placeholder="Search Target">
        </a-input-search>
        <a-button type="primary" icon="reload" @click="window.location.reload()">Reload</a-button>
      </div>
      <a-table :dataSource="webData"
               :expandRowByClick="true"
               rowKey="id"
               @expand="onExpand"
               :loading="loading"
               :pagination="false">
        <div slot="expandedRowRender"
             slot-scope="record"
             style="margin: 0">
          <a-descriptions bordered
                          class="expand-detail"
                          :column="1"
                          size="middle">
            <a-descriptions-item v-for="item in record.expand"
                                 :key="item.key"
                                 :label="item.key"
                                 :span="1">
              <template v-if="item.key.startsWith('Response')">
                <pre style="max-height: 600px; max-width: 100%">{{ item.value }}</pre>
              </template>
              <template v-else-if="item.key === 'URL'">
                <a :href="item.value" target="_blank">{{ item.value }}</a>
              </template>
              <template v-else>
                <pre>{{ item.value }}</pre>
              </template>
              <a @click="$copy(item.value)"
                 v-if="item.key.startsWith('Request')">Copy</a>
            </a-descriptions-item>
            <a-descriptions-item label="Action">
              <a @click="$emit('feedback', record)">这是误报？点击反馈</a>
              <br/><br/>
              <a @click="$emit('download', record)">下载本条数据</a>
            </a-descriptions-item>
          </a-descriptions>
        </div>
        <a-table-column
          title="ID"
          width="64px"
          :customRender="(text, record, index)=> index+1"
          key="id">
        </a-table-column>
        <a-table-column
          title="Target"
          key="target"
          :sorter="(a,b)=>a.target.url.localeCompare(b.target.url)">
          <template slot-scope="record">
            <a :href="record.target.url"
               style="display: inline-block; max-width: 50vw;"
               @click.prevent.stop="window.open(record.target.url)">
              {{ record.target.url}}
            </a>
          </template>
        </a-table-column>
        <a-table-column title="PluginName / VulnType"
                        key="plugin"
                        :sorter="(a,b) => (a.plugin+a.vuln_class).localeCompare(b.plugin + b.vuln_class)"
                        :filters="vulnTypes"
                        class="filter-column"
                        @filter="(value, record) => record.plugin.includes(value)">
          <template slot-scope="record">
            {{ record.plugin + (record.vuln_class ? `/${record.vuln_class}` : '') }}
          </template>
        </a-table-column>
        <a-table-column title="CreateTime"
                        key="create_time"
                        :sorter="(a, b) => a.create_time - b.create_time">
          <template slot-scope="record">
            {{ record.create_time | humanize }}
          </template>
        </a-table-column>
      </a-table>
    </a-card>
  </div>
</template>

<script>
export default {
  name: "web-vulnerability",
  mounted () {
    this.webData = this.data
  },
  props: {
    data: Array,
    loading: Boolean,
  },
  data () {
    return {
      window: window,
      searchWord: "",
      tableLoading: this.loading,
      webData: [],
    };
  },
  methods: {
    onSearchChange () {
      let webdata = []
      for (let vuln of this.data) {
        if (vuln.detail.addr.includes(this.searchWord)) {
          webdata.push(vuln)
        }
      }
      this.webData = webdata
    },
    onExpand (expanded, record) {
      if (record.expand) {
        return
      }
      let detail = record.detail
      let extra = record.detail.extra
      let expand = []
      if (detail.addr) {
        expand.push({
          key: "URL",
          value: detail.addr,
        })
      }
      if (extra && extra.param && Object.keys(extra.param).length !== 0) {
        expand.push({
          key: "ParamPosition",
          value: extra.param.position
        })
        expand.push({
          key: "ParamKey",
          value: extra.param.key
        })
      }
      if (detail.payload) {
        expand.push({
          key: "Payload",
          value: detail.payload
        })
      }
      if (detail.snapshot) {
        let i = 1
        for (let flow of detail.snapshot) {
          if (flow.length !== 0) {
            expand.push({
              key: "Request" + i.toString(),
              value: flow[0]
            })
            expand.push({
              key: "Response" + i.toString(),
              value: flow[1]
            })
            i++
          }
        }
      }

      let blankList = ["param", "payload", "addr"]
      let shouldIgnore = function (word) {
        for (let s of blankList) {
          if (word.includes(s)) {
            return true
          }
        }
        return false
      }
      let others = {}
      for (let [k, v] of Object.entries(detail.extra)) {
        if (shouldIgnore(k)) {
          continue
        }
        others[k] = v
      }
      if (Object.keys(others).length !== 0) {
        expand.push({
          key: "Extra",
          value: others
        })
      }
      record.expand = expand
    },
  },
  computed: {
    vulnTypes () {
      let s = new Set();
      for (let vuln of this.webData) {
        s.add(vuln.plugin)
      }
      let result = []
      for (let t of s.values()) {
        result.push({text: t, value: t})
      }
      return result
    }
  },
  watch: {
    data (newData) {
      this.webData = newData
    },
    loading (newData) {
      this.tableLoading = newData
    }
  }
}
</script>